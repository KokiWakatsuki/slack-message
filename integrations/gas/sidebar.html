<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        body {
            padding: 15px;
            background: #fafafa;
            font-size: 13px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .box {
            margin-bottom: 15px;
            border-top: 3px solid #3273dc;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .loader-box {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-top: 1px solid #dbdbdb;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        /* Make room for the loader at the bottom */
        body {
            padding-bottom: 80px;
        }

        .status-log {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 11px;
            background: #2d3436;
            color: #55efc4;
            padding: 10px;
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .step-num {
            background: #3273dc;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .button.is-small {
            font-weight: 600;
        }

        .help-text {
            color: #636e72;
            font-size: 11px;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <div class="box">
        <h2 class="title is-6"><span class="step-num">1</span> æº–å‚™</h2>
        <button class="button is-small is-link is-light is-fullwidth" onclick="run('runInitialSetup')">ğŸš€
            é€£æºã‚’é–‹å§‹ã™ã‚‹</button>
        <p class="help-text">â€» æœ€åˆã«1å›ã ã‘å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div class="box" style="border-top-color: #ff3860;">
        <h2 class="title is-6"><span class="step-num">2</span> éå»ãƒ‡ãƒ¼ã‚¿ (Drive)</h2>
        <p class="is-size-7 mb-2">Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ã•ã‚ŒãŸéå»ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚</p>
        <button id="importBtn" class="button is-danger is-small is-fullwidth mb-2"
            onclick="run('runImportFromExport')">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿é–‹å§‹</button>
        <button class="button is-ghost is-small is-fullwidth" onclick="run('resetImportState')">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>

    <div class="box" style="border-top-color: #ffdd57;">
        <h2 class="title is-6"><span class="step-num">3</span> æœ€æ–°ãƒ‡ãƒ¼ã‚¿ (Slack)</h2>
        <p class="is-size-7 mb-2">å–ã‚Šè¾¼ã¿ä»¥é™ã®æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦ã€æœ€æ–°ã®çŠ¶æ…‹ã«ã—ã¾ã™ã€‚</p>
        <button id="apiSyncBtn" class="button is-warning is-small is-fullwidth mb-2"
            onclick="run('importAllPastMessages')">ğŸ”„ æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°</button>
        <button class="button is-ghost is-small is-fullwidth" onclick="run('resetApiSyncStatus')">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>

    <div class="box" style="border-top-color: #00b894;">
        <h2 class="title is-6">å€‹åˆ¥ã®ä¿®æ­£</h2>
        <div class="control-group">
            <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                <div class="select is-small is-fullwidth">
                    <select id="channelList">
                        <option>èª­è¾¼ä¸­...</option>
                    </select>
                </div>
                <button id="refreshBtn" onclick="refreshChannelList()" class="button is-small"
                    title="ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚’æœ€æ–°ã«æ›´æ–°">ğŸ”„</button>
            </div>
            <button class="button is-success is-small is-fullwidth" onclick="runIndividual()">ã“ã®ãƒãƒ£ãƒ³ãƒãƒ«ã ã‘æ›´æ–°</button>
        </div>
        <p class="help-text">â€» ç‰¹å®šã®ãƒãƒ£ãƒ³ãƒãƒ«ã ã‘æ›´æ–°ã•ã‚Œãªã„å ´åˆã«ä½¿ã„ã¾ã™ã€‚</p>
    </div>

    <div class="box" style="border-top-color: #a29bfe;">
        <h2 class="title is-6">ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h2>
        <button class="button is-small is-dark is-fullwidth mb-2" onclick="run('checkDataIntegrity')">ãƒ‡ãƒ¼ã‚¿ã®å¥åº·è¨ºæ–­</button>
        <p class="help-text">â€» ã‚µã‚¤ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div id="loader" class="loader-box">
        <progress class="progress is-small is-info" max="100"></progress>
        <p id="loaderText" class="is-size-7">å‡¦ç†ä¸­... <br>âš ï¸ ã“ã®ã‚¿ãƒ–ã¯é–‰ã˜ãªã„ã§ãã ã•ã„<br>(åˆ¥ã®ã‚¿ãƒ–ã§ä½œæ¥­ã™ã‚‹ã®ã¯OKã§ã™)</p>
    </div>

    <div id="result" class="status-log">> READY...</div>

    <script>
        let pollInterval = null;

        // èµ·å‹•æ™‚ã«ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        window.onload = () => { loadChannels(); };

        function loadChannels() {
            google.script.run.withSuccessHandler(list => {
                const select = document.getElementById('channelList');
                if (list.length === 0) {
                    select.innerHTML = '<option>ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                    return;
                }
                select.innerHTML = list.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
            }).getChannelList();
        }

        /**
         * GASã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹
         */
        function run(funcName) {
            // Set Mode
            if (funcName === 'runImportFromExport') {
                currentMode = 'import';
            } else if (funcName === 'importAllPastMessages') {
                currentMode = 'api';
            } else {
                currentMode = null; // Other one-off tasks
            }

            // UI Reset
            toggleLoader(true);
            const progressBar = document.querySelector('progress.progress');
            if (progressBar) {
                progressBar.removeAttribute('value');
                progressBar.value = 0;
                progressBar.innerText = '0%';
            }

            startPolling(); // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            google.script.run
                .withSuccessHandler(msg => {
                    // onSuccesså†…ã§stopPollingã™ã‚‹ã‹åˆ¤æ–­ã™ã‚‹
                    onSuccess(msg);
                    // ãƒãƒ£ãƒ³ãƒãƒ«åŒæœŸå¾Œã¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    if (funcName === 'syncChannelsAndJoin' || funcName === 'runInitialSetup') loadChannels();
                })
                .withFailureHandler(onFailure)
            [funcName]();
        }

        /**
         * é¸æŠã—ãŸãƒãƒ£ãƒ³ãƒãƒ«ã®ã¿åŒæœŸã™ã‚‹
         */
        function runIndividual() {
            const select = document.getElementById('channelList');
            const channelId = select.value;
            const channelName = select.options[select.selectedIndex].text;

            if (!channelId || channelId.includes('èª­ã¿è¾¼ã¿')) return;

            currentMode = 'api'; // Individual run treated as API sync
            toggleLoader(true);
            const progressBar = document.querySelector('progress.progress');
            if (progressBar) progressBar.value = 0;

            startPolling();
            google.script.run
                .withSuccessHandler(msg => {
                    // onSuccess will handle the message, onStatusUpdate will handle completion
                    onSuccess(msg);
                })
                .withFailureHandler(onFailure)
                .runBackfillLogic(channelId, channelName);
        }

        /**
         * ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚’æœ€æ–°ã«æ›´æ–°ã™ã‚‹
         */
        function refreshChannelList() {
            const btn = document.getElementById('refreshBtn');
            const select = document.getElementById('channelList');

            btn.classList.add('is-loading');
            btn.setAttribute('disabled', 'true');
            select.setAttribute('disabled', 'true');

            google.script.run
                .withSuccessHandler(msg => {
                    // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    loadChannels();

                    // ãƒœã‚¿ãƒ³å¾©å¸°
                    btn.classList.remove('is-loading');
                    btn.removeAttribute('disabled');
                    select.removeAttribute('disabled');

                    // å®Œäº†ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆç°¡æ˜“ï¼‰
                    const resultDiv = document.getElementById('result');
                    resultDiv.innerText = '> âœ… ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ';
                })
                .withFailureHandler(err => {
                    btn.classList.remove('is-loading');
                    btn.removeAttribute('disabled');
                    select.removeAttribute('disabled');
                    onFailure(err);
                })
                .syncChannelsAndJoin();
        }

        function toggleLoader(val) {
            document.getElementById('loader').style.display = val ? 'block' : 'none';
            if (val) {
                document.getElementById('result').innerText = '> å®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...';
                const loaderText = document.getElementById('loaderText');
                if (loaderText) loaderText.innerHTML = 'å‡¦ç†ä¸­... <br>âš ï¸ ã“ã®ã‚¿ãƒ–ã¯é–‰ã˜ãªã„ã§ãã ã•ã„<br>(åˆ¥ã®ã‚¿ãƒ–ã§ä½œæ¥­ã™ã‚‹ã®ã¯OKã§ã™)';
            }
        }

        // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        function startPolling() {
            if (pollInterval) return;
            pollInterval = setInterval(checkStatus, 5000); // 5ç§’ã”ã¨ã«ç¢ºèª
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function checkStatus() {
            // New polling function
            google.script.run.withSuccessHandler(onStatusUpdate).getAllStatus();
        }

        function onStatusUpdate(statusJson) {
            // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢æ¸ˆã¿ãªã‚‰æ›´æ–°ã—ãªã„ï¼ˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸Šæ›¸ãé˜²æ­¢ï¼‰
            if (!pollInterval || !statusJson || !currentMode) return;
            const allStatus = JSON.parse(statusJson);

            let status = null;
            if (currentMode === 'import') {
                status = allStatus.import;
            } else if (currentMode === 'api') {
                status = allStatus.api;
            }

            if (!status) return; // No status for current mode

            const progressBar = document.querySelector('progress.progress');
            const resultDiv = document.getElementById('result');
            const loaderText = document.getElementById('loaderText');

            // === IMPORT MODE LOGIC ===
            if (currentMode === 'import') {
                if (status.isRepairing) {
                    if (progressBar) {
                        progressBar.removeAttribute('value');
                        progressBar.value = 100;
                        progressBar.innerText = '100%';
                    }
                    resultDiv.innerText = '> ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿ãŒå®Œäº†ã—ã€ã‚¹ãƒ¬ãƒƒãƒ‰é–¢ä¿‚ã‚’ä¿®å¾©ã—ã¦ã„ã¾ã™...\n> (æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)';

                    if (loaderText) loaderText.innerHTML = 'ã‚¹ãƒ¬ãƒƒãƒ‰é–¢ä¿‚ã‚’ä¿®å¾©ä¸­...<br>âš ï¸ ã“ã®ã‚¿ãƒ–ã¯é–‰ã˜ãªã„ã§ãã ã•ã„';

                } else if (status.totalFolders > 0) {
                    const percent = Math.floor((status.completedFolders.length / status.totalFolders) * 100);
                    if (progressBar) {
                        progressBar.value = percent;
                        progressBar.innerText = `${percent}%`;
                    }
                }
            }

            // === API SYNC MODE LOGIC ===
            else if (currentMode === 'api') {
                if (status.channels && status.channels.length > 0) {
                    const percent = Math.floor((status.lastIndex / status.channels.length) * 100);
                    if (progressBar) {
                        progressBar.value = percent;
                        progressBar.innerText = `${percent}%`;
                    }
                }
            }

            // Check for completion
            if (status.isCompleted) {
                stopPolling();
                toggleLoader(false);
                resultDiv.innerText = '> âœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
                if (progressBar) progressBar.value = 100;

                // Reset buttons
                const importBtn = document.getElementById('importBtn');
                if (importBtn) {
                    importBtn.innerText = 'ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿é–‹å§‹';
                    importBtn.classList.remove('is-loading');
                    importBtn.removeAttribute('disabled');
                }
                const apiBtn = document.getElementById('apiSyncBtn');
                if (apiBtn) {
                    apiBtn.innerText = 'ğŸ”„ æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°';
                    apiBtn.classList.remove('is-loading');
                    apiBtn.removeAttribute('disabled');
                }
                currentMode = null; // Reset mode
                return;
            }


            // ã‚¹ãƒˆãƒ¼ãƒ«æ¤œçŸ¥ (å…±é€šãƒ­ã‚¸ãƒƒã‚¯)
            const now = new Date().getTime();
            // ä¿®å¾©ä¸­ã¯3åˆ†ã€ãã‚Œä»¥å¤–ã¯2åˆ† (é »ç¹ã«æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚çŸ­ç¸®)
            const timeoutMs = (currentMode === 'import' && status.isRepairing) ? 3 * 60 * 1000 : 2 * 60 * 1000;

            if (status.lastUpdated && (now - status.lastUpdated > timeoutMs)) {
                stopPolling();
                toggleLoader(false);

                if (currentMode === 'import' && status.isRepairing) {
                    resultDiv.innerText = '> âš ï¸ ä¿®å¾©å‡¦ç†ãŒåœæ­¢ã—ã¾ã—ãŸ (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ)ã€‚\n> ãã®ã¾ã¾ã€Œå†é–‹ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    resultDiv.innerText = '> âš ï¸ è‡ªå‹•å‡¦ç†ãŒåœæ­¢ã—ãŸã‚ˆã†ã§ã™ (ä¸€å®šæ™‚é–“å¿œç­”ãªã—)ã€‚\n> ãã®ã¾ã¾ãƒœã‚¿ãƒ³ã‚’å†åº¦æŠ¼ã—ã¦å†é–‹ã—ã¦ãã ã•ã„ã€‚';
                }

                // ãƒœã‚¿ãƒ³ã®å¾©å¸°ï¼ˆæœ¬æ¥ã¯æŠ¼ã—ãŸãƒœã‚¿ãƒ³ã‚’ç‰¹å®šã™ã¹ãã ãŒã€importBtnã‚’ä»£è¡¨ã«ã—ã¦ãŠãã‹ã€ã‚ã‚‹ã„ã¯ä¸¡æ–¹ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã‹ï¼‰
                // ç°¡æ˜“çš„ã«ä¸¡æ–¹ãƒªã‚»ãƒƒãƒˆ
                const importBtn = document.getElementById('importBtn');
                if (importBtn) {
                    importBtn.innerText = 'ğŸ”„ å†é–‹ã™ã‚‹';
                    importBtn.classList.remove('is-loading');
                    importBtn.removeAttribute('disabled');
                }
                const apiBtn = document.getElementById('apiSyncBtn');
                if (apiBtn) {
                    apiBtn.innerText = 'ğŸ”„ å†é–‹ã™ã‚‹';
                    apiBtn.classList.remove('is-loading');
                    apiBtn.removeAttribute('disabled');
                }
                currentMode = null; // Reset mode
            }
        }

        function onSuccess(msg) {
            // onSuccessã¯ã‚ãã¾ã§ã€Œãƒˆãƒªã‚¬ãƒ¼äºˆç´„ãŒå®Œäº†ã—ãŸã€ã“ã¨ã®é€šçŸ¥ã«éããªã„
            // å®Ÿéš›ã«ã¯è£ã§å‹•ã„ã¦ã„ã‚‹ã®ã§ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ­¢ã‚ãªã„

            const resultDiv = document.getElementById('result');
            resultDiv.innerText = '> ' + msg;

            // Progress Parsing from msg (Initial sync)
            const match = msg.match(/(\d+)\s*\/\s*(\d+)/);
            if (match) {
                const current = parseInt(match[1]);
                const total = parseInt(match[2]);
                if (total > 0) {
                    const percent = Math.floor((current / total) * 100);
                    const progressBar = document.querySelector('progress.progress');
                    if (progressBar) {
                        progressBar.value = percent;
                    }
                }
            }

            // ä¸­æ–­ã¾ãŸã¯ãƒã‚¤ãƒ«ãƒ‰ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´ã—ã¦ãƒãƒ¼ãƒªãƒ³ã‚°ç¶™ç¶š
            if (msg.includes('ç¶™ç¶š') || msg.includes('å†é–‹')) {
                document.getElementById('importBtn').innerText = 'ğŸ”„ è‡ªå‹•ç¶™ç¶šãƒ¢ãƒ¼ãƒ‰ä¸­...';
                document.getElementById('importBtn').classList.add('is-loading');
                document.getElementById('importBtn').setAttribute('disabled', 'true');
                toggleLoader(true); // Ensure loader is ON
                startPolling(); // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            } else if (msg.includes('å®Œäº†')) {
                const progressBar = document.querySelector('progress.progress');
                if (progressBar) progressBar.value = 100;
                document.getElementById('importBtn').innerText = 'ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šè¾¼ã¿é–‹å§‹';
                document.getElementById('importBtn').classList.remove('is-loading');
                document.getElementById('importBtn').removeAttribute('disabled');
                stopPolling();
                toggleLoader(false);
            } else {
                // ãã®ä»–ã®å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒªã‚»ãƒƒãƒˆãªã©ï¼‰
                stopPolling();
                toggleLoader(false);
            }
        }

        function onFailure(err) {
            stopPolling();
            toggleLoader(false);
            document.getElementById('result').innerText = '> ã€è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã€‘\n' + err;
        }
    </script>
</body>

</html>